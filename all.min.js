let $aggregatedPostMetrics=$("#aggregatedPostMetrics"),$missingProfileLabels=$("#missingProfileLabels"),$aggregatedPostMetricsSpinner=$("#aggregatedPostMetricsSpinner").hide(),$dimensionsSelect=$("#aggregated_post_dimensions"),$aggregatedPostMetricsSelect=$("#aggregated_post_metrics"),$aggregatedPostTimedimension=$("#aggregated_post_timedimension");$(function(){$aggregatedPostMetrics.submit(onAggregatedPostMetricsSubmit)});async function onAggregatedPostMetricsSubmit(e){e.preventDefault(),$aggregatedPostMetricsSpinner.show(),SBKS.aggregated_post_metrics=[],SBKS.aggregated_post_dimensions=[];for(const t of $aggregatedPostMetrics.serializeArray())"daterange"!==t.name?"time"!==t.name?(SBKS[t.name]=SBKS[t.name]||[],SBKS[t.name].push(t.value)):t.value&&SBKS.aggregated_post_dimensions.unshift(t.value):SBKS.date_range=parseDateRange(t.value);tableau.connectionData=JSON.stringify(SBKS),invokeConnector(SBKS.data_source)}function renderAggregatedPostMetrics(){$aggregatedPostMetrics.show(),$missingProfileLabels.empty();let e=[],t=[];for(const[n,i]of Object.entries(SBKS.profiles_selected)){var a=Object.entries(i).find(e=>e[1]?e:null);for(const s of Object.keys(AGGREGATED_POST_METRICS[n]))!a&&0===s.indexOf("insights")||e.find(e=>e.id===s)||e.push({id:s,text:s});t=[...t,...Object.keys(i).filter(e=>SBKS.profiles_with_no_labels[n].includes(e))]}$("select").each(function(){10<$(this).outerWidth()&&$(this).css({width:`${$(this).outerWidth()-1}px`})}),$aggregatedPostMetricsSelect.select2({multiple:!0,data:e}).change(onMetricsChange),$aggregatedPostTimedimension.change(onMetricsChange),t.length&&$missingProfileLabels.append($(`
        <div class="alert alert-info" role="alert">
            Some profiles you selected don't have profile labels. If you select profile_label as a dimension
            the data for that profile will not be shown.<br>
            Profiles: ${t.map(e=>SBKS.profile_name_by_id[e]).join(", ")}
        </div>
        `))}function onMetricsChange(){let e=[];for(const n of $aggregatedPostMetricsSelect.val())for(const i of Object.keys(SBKS.profiles_selected)){var t=AGGREGATED_POST_METRICS[i][n];t&&(e=e.length?intersect(e,t):t)}$aggregatedPostMetricsSelect.val().includes("sentiment_manual_auto")&&$dimensionsSelect.val("sentiment");var a=$dimensionsSelect.val();$dimensionsSelect.empty().select2({multiple:!0,data:e.map(e=>({id:e,text:e})),maximumSelectionLength:""===$aggregatedPostTimedimension.val()?2:1}).val(a).trigger("change")}function createHeaders(){return{"Content-Type":"application/json; charset=utf-8",Authorization:`Basic ${btoa(`${tableau.username}:${tableau.password}`)}`,"x-api-consumer":"Tableau V3"}}async function callSbksApi(e,t,a){let n=await fetch(SBKS.apiUrl+e,{method:t,headers:createHeaders(),body:a?JSON.stringify(a):null});return await n.json()}async function doApiCall(e,a,t){let n=await callSbksApi(e,"POST",t);if(n.success){if(n.header)for(var[i,s]of n.header.entries())"profile_label"===s.type?n.header[i].rows=s.rows.map(t=>{var e=a.profile_labels.find(e=>e.id===t);return e?e.name:t}):"post_labels"===s.type&&(n.header[i].rows=s.rows.map(t=>{var e=a.post_labels.find(e=>e.id===t);return e?e.name:t}));return n}console.log("API Request Failed",n)}function chunkArray(e,t){let a=0,n=[];var i=e.length;for(a=0;a<i;a+=t)n.push(e.slice(a,a+t));return n}function splitDateRange(e,t,a){t=moment(t);let n=Array.from(moment.range(moment(e),t).by("days",{step:a}));n.push(t);let i={},s=null;for(const o of n)s=s?(i[s.format("YYYY-MM-DD")]=o.format("YYYY-MM-DD"),o.add(1,"day")):o;return i}function combineMerge(e,t,a){let n=e.slice();for(var[i,s]of t.entries())void 0===n[i]?n[i]=a.cloneUnlessOtherwiseSpecified(s,a):a.isMergeableObject(s)?n[i]=deepmerge(e[i],s,a):-1===e.indexOf(s)&&n.push(s);return n}function intersect(e,t){return e.filter(Set.prototype.has,new Set(t))}function parseDateRange(e){let[t,a]=e.split(" - ");return t=moment(t,"MM/DD/YYYY"),a=moment(a,"MM/DD/YYYY"),{start:t.format("YYYY-MM-DD"),end:a.format("YYYY-MM-DD"),end_today:a.isSame(moment(),"day")}}function adjustDateRange(e){let t=moment(e.start,"YYYY-MM-DD"),a=moment(e.end,"YYYY-MM-DD");return e.end_today&&(a=moment().format("YYYY-MM-DD"),t=t.add(moment().diff(a,"days"),"days").format("YYYY-MM-DD")),{start:t,end:a}}$(function(){window["moment-range"].extendMoment(moment),$("input[name=daterange]").daterangepicker({startDate:moment().subtract(29,"days"),endDate:moment(),minDate:"01/01/2008",maxDate:moment(),alwaysShowCalendars:!0,showDropdowns:!0,ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment().subtract(1,"days")],"Last 7 Days":[moment().subtract(6,"days"),moment()],"Last 30 Days":[moment().subtract(29,"days"),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")],"This Year":[moment().startOf("year"),moment()],"Last Year":[moment().subtract(1,"year").startOf("year"),moment().subtract(1,"year").endOf("year")]}})});let SBKS={apiUrl:"https://api.socialbakers.com/",postsUrl:{facebook:"3/facebook/page/posts",instagram:"3/instagram/profile/posts",youtube:"3/youtube/profile/videos",twitter:"3/twitter/profile/tweets",linkedin:"3/linkedin/profile/posts",pinterest:"3/pinterest/profile/posts",vkontakte:"3/vkontakte/profile/posts"},data_source:"profile",networks:["facebook","instagram","twitter","youtube","linkedin","pinterest","vkontakte"],icons:{facebook:"logo-facebook",instagram:"logo-instagram",twitter:"logo-twitter",youtube:"logo-youtube",linkedin:"logo-linkedin",pinterest:"logo-pinterest",vk:"logo-vk"},profiles:{},profiles_selected:{},profile_labels:[],post_labels:[],profile_labels_selected:[],profile_metrics:{},profile_dimensions:{},profiles_with_no_labels:{},profile_name_by_id:{},aggregated_post_metrics:[],aggregated_post_dimensions:[],posts_filters:{},posts_networks:{}},PROFILE_COMMON_DIMENSIONS=["profile","profile_label"],PROFILE_METRICS={facebook:{fans_change:PROFILE_COMMON_DIMENSIONS,fans_lifetime:PROFILE_COMMON_DIMENSIONS,insights_activity:PROFILE_COMMON_DIMENSIONS.concat(["activity_type"]),insights_activity_unique:PROFILE_COMMON_DIMENSIONS.concat(["activity_type","gender_age","city","country","locale"]),insights_engaged_users:PROFILE_COMMON_DIMENSIONS,insights_fan_adds:PROFILE_COMMON_DIMENSIONS.concat(["like_source"]),insights_fan_adds_unique:PROFILE_COMMON_DIMENSIONS.concat(["like_source"]),insights_fan_removes:PROFILE_COMMON_DIMENSIONS,insights_fan_removes_unique:PROFILE_COMMON_DIMENSIONS.concat(["unlike_source"]),insights_fans_lifetime:PROFILE_COMMON_DIMENSIONS.concat(["gender_age","city","country","locale"]),insights_fans_online:PROFILE_COMMON_DIMENSIONS.concat(["hour_of_day"]),insights_impressions:PROFILE_COMMON_DIMENSIONS.concat(["activity_type","post_attribution"]),insights_negative_feedback:PROFILE_COMMON_DIMENSIONS,insights_positive_feedback:PROFILE_COMMON_DIMENSIONS.concat(["positive_feedback_type"]),insights_post_clicks:PROFILE_COMMON_DIMENSIONS.concat(["click_type"]),insights_post_clicks_unique:PROFILE_COMMON_DIMENSIONS.concat(["click_type"]),insights_post_impressions:PROFILE_COMMON_DIMENSIONS.concat(["post_attribution"]),insights_post_reach:PROFILE_COMMON_DIMENSIONS.concat(["post_attribution","frequency_distribution"]),insights_reach:PROFILE_COMMON_DIMENSIONS.concat(["gender_age","post_attribution"]),insights_reach_28_days:PROFILE_COMMON_DIMENSIONS.concat(["gender_age"]),insights_reach_7_days:PROFILE_COMMON_DIMENSIONS.concat(["gender_age"]),insights_reach_engagement:PROFILE_COMMON_DIMENSIONS,insights_reactions:PROFILE_COMMON_DIMENSIONS.concat(["reaction_type"]),insights_video_complete_views_30s:PROFILE_COMMON_DIMENSIONS.concat(["play_type","post_attribution"]),insights_video_complete_views_30s_repeat_views:PROFILE_COMMON_DIMENSIONS,insights_video_complete_views_30s_unique:PROFILE_COMMON_DIMENSIONS,insights_video_repeat_views:PROFILE_COMMON_DIMENSIONS,insights_video_views:PROFILE_COMMON_DIMENSIONS.concat(["play_type","post_attribution"]),insights_video_views_unique:PROFILE_COMMON_DIMENSIONS,insights_views:PROFILE_COMMON_DIMENSIONS},instagram:{followers_change:PROFILE_COMMON_DIMENSIONS,followers_lifetime:PROFILE_COMMON_DIMENSIONS,following_change:PROFILE_COMMON_DIMENSIONS,following_lifetime:PROFILE_COMMON_DIMENSIONS,insights_followers:PROFILE_COMMON_DIMENSIONS.concat(["country","locale","city","gender_age"]),insights_impressions:PROFILE_COMMON_DIMENSIONS,insights_impressions_28_days:PROFILE_COMMON_DIMENSIONS,insights_impressions_7_days:PROFILE_COMMON_DIMENSIONS,insights_profile_clicks:PROFILE_COMMON_DIMENSIONS.concat(["click_target"]),insights_profile_views:PROFILE_COMMON_DIMENSIONS,insights_reach:PROFILE_COMMON_DIMENSIONS,insights_reach_28_days:PROFILE_COMMON_DIMENSIONS,insights_reach_7_days:PROFILE_COMMON_DIMENSIONS},twitter:{ff_ratio:PROFILE_COMMON_DIMENSIONS,followers_change:PROFILE_COMMON_DIMENSIONS,followers_lifetime:PROFILE_COMMON_DIMENSIONS,following_change:PROFILE_COMMON_DIMENSIONS,following_lifetime:PROFILE_COMMON_DIMENSIONS,listed_change:PROFILE_COMMON_DIMENSIONS,listed_lifetime:PROFILE_COMMON_DIMENSIONS},youtube:{interaction_change:PROFILE_COMMON_DIMENSIONS.concat(["interaction_type"]),interactions_per_1k_fans:PROFILE_COMMON_DIMENSIONS,subscribers_change:PROFILE_COMMON_DIMENSIONS,subscribers_lifetime:PROFILE_COMMON_DIMENSIONS,video_lifetime:PROFILE_COMMON_DIMENSIONS,viewed_time_change:PROFILE_COMMON_DIMENSIONS,views_change:PROFILE_COMMON_DIMENSIONS},linkedin:{followers_change:PROFILE_COMMON_DIMENSIONS,followers_lifetime:PROFILE_COMMON_DIMENSIONS},pinterest:{boards_change:PROFILE_COMMON_DIMENSIONS,boards_lifetime:PROFILE_COMMON_DIMENSIONS,followers_change:PROFILE_COMMON_DIMENSIONS,followers_lifetime:PROFILE_COMMON_DIMENSIONS,following_change:PROFILE_COMMON_DIMENSIONS,following_lifetime:PROFILE_COMMON_DIMENSIONS,pins_lifetime:PROFILE_COMMON_DIMENSIONS}},common_agg_dimensions=["platform","profile","post_labels","profile_label"],insights_engagements=common_agg_dimensions.concat(["media_type","content_type"]),engagement_rate=insights_engagements.concat(["published_status","sentiment_type"]),insights_video_views=common_agg_dimensions.concat(["content_type","published_status","sentiment_type"]),interactions=engagement_rate.concat(["interaction_type"]),likes=common_agg_dimensions.concat(["media_type","sentiment_type"]),sentiment_manual_auto=common_agg_dimensions.concat(["media_type","sentiment"]),shares=insights_engagements.concat(["published_status"]),user_posts_responded=insights_engagements.concat(["response_time"]),AGGREGATED_POST_METRICS={facebook:{engagement_rate:engagement_rate,insights_engagements:insights_engagements,insights_impressions:engagement_rate,insights_post_clicks:common_agg_dimensions.concat(["content_type","media_type","published_status"]),insights_reach_engagement:common_agg_dimensions.concat(["content_type","media_type","published_status"]),insights_reach_per_content:engagement_rate,insights_video_views:insights_video_views,interactions:interactions,interactions_per_1k_fans:engagement_rate,likes:likes,number_of_comments:engagement_rate,page_posts:engagement_rate,page_shares:common_agg_dimensions,sentiment_manual_auto:sentiment_manual_auto,shares:shares,user_posts:insights_engagements,user_posts_average_response_time:insights_engagements,user_posts_responded:user_posts_responded,user_posts_response_rate:insights_engagements,user_questions_average_response_time:insights_engagements,user_questions_responded:user_posts_responded,user_questions_response_rate:engagement_rate},instagram:{engagement_rate:engagement_rate,insights_completion_rate:common_agg_dimensions.concat(["media_type"]),insights_engagements:insights_engagements,insights_impressions:engagement_rate,insights_reach_per_content:engagement_rate,insights_story_exits:common_agg_dimensions.concat(["media_type"]),insights_story_taps_back:common_agg_dimensions.concat(["media_type"]),insights_story_taps_forward:common_agg_dimensions.concat(["media_type"]),insights_video_views:insights_video_views,interactions:interactions,interactions_per_1k_fans:engagement_rate,likes:likes,number_of_comments:engagement_rate,page_posts:engagement_rate,sentiment_manual_auto:sentiment_manual_auto},twitter:{engagement_rate:engagement_rate,insights_engagements:insights_engagements,insights_impressions:engagement_rate,insights_media_views:common_agg_dimensions.concat(["content_type","media_type","sentiment_type"]),insights_video_views:insights_video_views,interactions:interactions,interactions_per_1k_fans:engagement_rate,likes:likes,number_of_comments:engagement_rate,page_posts:engagement_rate,page_replies:common_agg_dimensions,page_shares:common_agg_dimensions,profile_tweets:common_agg_dimensions.concat(["media_type"]),sentiment_manual_auto:sentiment_manual_auto,shares:shares,user_posts:insights_engagements,user_posts_average_response_time:insights_engagements,user_posts_responded:user_posts_responded,user_posts_response_rate:insights_engagements,user_questions_average_response_time:insights_engagements,user_questions_responded:user_posts_responded,user_questions_response_rate:engagement_rate},youtube:{engagement_rate:engagement_rate,insights_video_views:insights_video_views,interactions:interactions,interactions_per_1k_fans:engagement_rate,likes:likes,number_of_comments:engagement_rate,page_posts:engagement_rate},linkedin:{engagement_rate:engagement_rate,interactions:interactions,interactions_per_1k_fans:engagement_rate,number_of_comments:engagement_rate,page_posts:engagement_rate,sentiment_manual_auto:sentiment_manual_auto},pinterest:{interactions:interactions,number_of_comments:engagement_rate,page_posts:engagement_rate,page_shares:common_agg_dimensions,shares:shares},vkontakte:{engagement_rate:engagement_rate,interactions:interactions,interactions_per_1k_fans:engagement_rate,number_of_comments:engagement_rate,page_posts:engagement_rate,shares:shares}},ID_NAME_URL={id:tableau.dataTypeEnum.string,name:tableau.dataTypeEnum.string,url:tableau.dataTypeEnum.string},POSTS_SORT_FIELDS={comments:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],created_time:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],interactions:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],interactions_per_1k_fans:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],reactions:["facebook","linkedin"],"reactions_by_type.anger":["facebook"],"reactions_by_type.haha":["facebook"],"reactions_by_type.like":["facebook"],"reactions_by_type.love":["facebook"],"reactions_by_type.sorry":["facebook"],"reactions_by_type.wow":["facebook"],shares:["facebook","pinterest","vkontakte"],insights_engaged_users:["facebook"],insights_post_clicks:["facebook"],"insights_reach_by_post_attribution.organic":["facebook"],"insights_reach_by_post_attribution.paid":["facebook"],insights_reach_engagement_rate:["facebook"],insights_video_view_time_average:["facebook"],insights_video_views_10s:["facebook"],"insights_video_views_by_post_attribution.organic":["facebook"],"insights_video_views_by_post_attribution.paid":["facebook"],likes:["instagram","youtube","vkontakte"],insights_impressions:["instagram"],insights_reach:["instagram"],insights_saves:["instagram"],insights_story_completion_rate:["instagram"],insights_story_exits:["instagram"],insights_story_taps_back:["instagram"],insights_story_taps_forward:["instagram"],insights_video_views:["instagram"],dislikes:["youtube"],duration:["youtube"],video_view_time:["youtube"],video_views:["youtube"]},POSTS_FILTER_FIELDS={content_type:{facebook:["post","shared"],instagram:["post","story"],twitter:[],youtube:[],linkedin:[],pinterest:["post","shared"],vkontakte:[]},grade:{facebook:["A+","A","B","C","D"],instagram:["A+","A","B","C","D"],youtube:[],twitter:[],linkedin:[],pinterest:[],vkontakte:[]},media_type:{facebook:["status","link","video","note","poll","offer","photo","carousel"],instagram:["video","photo","carousel"],youtube:["video"],twitter:[],linkedin:["status","link","video","photo","album","carousel"],pinterest:[],vkontakte:["status","photo","video","link","note","poll","album"]},origin:{facebook:["User-Generated Content","Brand's Content"],instagram:[],youtube:[],twitter:["User-Generated Content","Brand's Content"],linkedin:[],pinterest:[],vkontakte:["User-Generated Content","Brand's Content"]},post_attribution:{facebook:["organic","paid"],instagram:["organic","paid"],youtube:[],twitter:[],linkedin:[],pinterest:[],vkontakte:[]},video_type:{facebook:["crosspost","crosspostable","live","shared"],instagram:[],youtube:[],twitter:[],linkedin:[],pinterest:[],vkontakte:[]},post_labels:{facebook:[],instagram:[],youtube:[],twitter:[],linkedin:[],pinterest:[],vkontakte:[]}},POSTS_FIELDS={attachments:{networks:["facebook","instagram","linkedin","pinterest","vkontakte"],array:!0,subfields:{title:tableau.dataTypeEnum.string,description:tableau.dataTypeEnum.string,type:tableau.dataTypeEnum.string,url:tableau.dataTypeEnum.string,image_url:tableau.dataTypeEnum.string}},author:{networks:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],subfields:ID_NAME_URL},channel:{networks:["youtube"],subfields:ID_NAME_URL},comments:{networks:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],type:tableau.dataTypeEnum.int},comments_sentiment:{networks:["facebook"],subfields:{positive:tableau.dataTypeEnum.int,neutral:tableau.dataTypeEnum.int,negative:tableau.dataTypeEnum.int}},content:{networks:["facebook","linkedin","pinterest","vkontakte"],type:tableau.dataTypeEnum.string},content_type:{networks:["facebook","instagram","linkedin","pinterest","vkontakte"],type:tableau.dataTypeEnum.string},created_time:{networks:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],type:tableau.dataTypeEnum.datetime},deleted:{networks:["facebook"],type:tableau.dataTypeEnum.bool},description:{networks:["youtube"],type:tableau.dataTypeEnum.string},dislikes:{networks:["youtube"],type:tableau.dataTypeEnum.int},duration:{networks:["youtube"],type:tableau.dataTypeEnum.int},grade:{networks:["facebook","instagram"],type:tableau.dataTypeEnum.string},hidden:{networks:["facebook"],type:tableau.dataTypeEnum.bool},id:{networks:["facebook","instagram","youtube","twitter","linkedin","pinterest","vkontakte"],type:tableau.dataTypeEnum.string},interactions:{networks:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],type:tableau.dataTypeEnum.int},interactions_per_1k_fans:{networks:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],type:tableau.dataTypeEnum.float},likes:{networks:["instagram","youtube","vkontakte"],type:tableau.dataTypeEnum.int},media_type:{networks:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],type:tableau.dataTypeEnum.string},origin:{networks:["facebook","twitter","vkontakte"],type:tableau.dataTypeEnum.string},page:{networks:["facebook","instagram","linkedin","vkontakte"],subfields:ID_NAME_URL},post_attribution:{networks:["facebook","instagram"],subfields:{status:tableau.dataTypeEnum.string,type:tableau.dataTypeEnum.string}},post_labels:{networks:["facebook","instagram","youtube","twitter","linkedin","pinterest","vkontakte"],array:!0,subfields:{id:tableau.dataTypeEnum.string,name:tableau.dataTypeEnum.string}},profile:{networks:["twitter","pinterest"],subfields:ID_NAME_URL},published:{networks:["facebook"],type:tableau.dataTypeEnum.bool},reactions:{networks:["facebook","linkedin"],type:tableau.dataTypeEnum.int},reactions_by_type:{networks:["facebook"],subfields:{like:tableau.dataTypeEnum.int,love:tableau.dataTypeEnum.int,wow:tableau.dataTypeEnum.int,haha:tableau.dataTypeEnum.int,sorry:tableau.dataTypeEnum.int,anger:tableau.dataTypeEnum.int}},sentiment:{networks:["facebook","instagram"],type:tableau.dataTypeEnum.string},shares:{networks:["facebook","pinterest","vkontakte"],type:tableau.dataTypeEnum.int},spam:{networks:["facebook"],type:tableau.dataTypeEnum.bool},universal_video_id:{networks:["facebook"],type:tableau.dataTypeEnum.int},url:{networks:["facebook","instagram","youtube","linkedin","pinterest","vkontakte"],type:tableau.dataTypeEnum.string},video:{networks:["facebook"],subfields:{id:tableau.dataTypeEnum.string,length:tableau.dataTypeEnum.int,crosspost:tableau.dataTypeEnum.bool,crosspostable:tableau.dataTypeEnum.bool,live:tableau.dataTypeEnum.bool,shared:tableau.dataTypeEnum.bool}},video_view_time:{networks:["youtube"],type:tableau.dataTypeEnum.int},video_views:{networks:["youtube"],type:tableau.dataTypeEnum.int},insights_engaged_users:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_engagement:{networks:["instagram"],type:tableau.dataTypeEnum.int},insights_engagement_by_engagement_type:{networks:["instagram"],subfields:{comments:tableau.dataTypeEnum.int,likes:tableau.dataTypeEnum.int,saves:tableau.dataTypeEnum.int}},insights_impressions:{networks:["facebook","instagram"],type:tableau.dataTypeEnum.int},insights_impressions_by_post_attribution:{networks:["facebook"],subfields:{paid:tableau.dataTypeEnum.int,organic:tableau.dataTypeEnum.int,viral:tableau.dataTypeEnum.int}},insights_interactions:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_interactions_by_interaction_type:{networks:["facebook"],subfields:{comment:tableau.dataTypeEnum.int,like:tableau.dataTypeEnum.int,share:tableau.dataTypeEnum.int}},insights_negative_feedback_unique:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_post_clicks:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_post_clicks_by_clicks_type:{networks:["facebook"],subfields:{link_clicks:tableau.dataTypeEnum.int,button_clicks:tableau.dataTypeEnum.int,other_clicks:tableau.dataTypeEnum.int,photo_views:tableau.dataTypeEnum.int,video_plays:tableau.dataTypeEnum.int}},insights_post_clicks_unique:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_reach:{networks:["facebook","instagram"],type:tableau.dataTypeEnum.int},insights_reach_by_post_attribution:{networks:["facebook"],subfields:{paid:tableau.dataTypeEnum.int,organic:tableau.dataTypeEnum.int,viral:tableau.dataTypeEnum.int}},insights_reach_engagement_rate:{networks:["facebook"],type:tableau.dataTypeEnum.float},insights_reactions:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_reactions_by_type:{networks:["facebook"],subfields:{like:tableau.dataTypeEnum.int,love:tableau.dataTypeEnum.int,wow:tableau.dataTypeEnum.int,haha:tableau.dataTypeEnum.int,sorry:tableau.dataTypeEnum.int,anger:tableau.dataTypeEnum.int}},insights_saves:{networks:["instagram"],type:tableau.dataTypeEnum.int},insights_story_completion_rate:{networks:["instagram"],type:tableau.dataTypeEnum.float},insights_story_exits:{networks:["instagram"],type:tableau.dataTypeEnum.int},insights_story_replies:{networks:["instagram"],type:tableau.dataTypeEnum.int},insights_story_taps_back:{networks:["instagram"],type:tableau.dataTypeEnum.int},insights_story_taps_forward:{networks:["instagram"],type:tableau.dataTypeEnum.int},insights_video_view_time:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_video_view_time_average:{networks:["facebook"],type:tableau.dataTypeEnum.float},insights_video_view_time_by_distribution:{networks:["facebook"],subfields:{owned:tableau.dataTypeEnum.int,shared:tableau.dataTypeEnum.int}},insights_video_view_time_by_post_attribution:{networks:["facebook"],subfields:{organic:tableau.dataTypeEnum.int,paid:tableau.dataTypeEnum.int}},insights_video_views:{networks:["facebook","instagram"],type:tableau.dataTypeEnum.int},insights_video_views_10s:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_video_views_10s_by_play_type:{networks:["facebook"],subfields:{autoplayed:tableau.dataTypeEnum.int,click_to_play:tableau.dataTypeEnum.int}},insights_video_views_10s_by_post_attribution:{networks:["facebook"],subfields:{organic:tableau.dataTypeEnum.int,paid:tableau.dataTypeEnum.int}},insights_video_views_10s_by_sound:{networks:["facebook"],subfields:{on:tableau.dataTypeEnum.int,off:tableau.dataTypeEnum.int}},insights_video_views_10s_unique:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_video_views_30s:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_video_views_30s_by_play_type:{networks:["facebook"],subfields:{autoplayed:tableau.dataTypeEnum.int,click_to_play:tableau.dataTypeEnum.int}},insights_video_views_30s_by_post_attribution:{networks:["facebook"],subfields:{organic:tableau.dataTypeEnum.int,paid:tableau.dataTypeEnum.int}},insights_video_views_30s_unique:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_video_views_average_completion:{networks:["facebook"],type:tableau.dataTypeEnum.float},insights_video_views_by_play_type:{networks:["facebook"],subfields:{autoplayed:tableau.dataTypeEnum.int,click_to_play:tableau.dataTypeEnum.int}},insights_video_views_by_post_attribution:{networks:["facebook"],subfields:{organic:tableau.dataTypeEnum.int,paid:tableau.dataTypeEnum.int}},insights_video_views_by_sound:{networks:["facebook"],subfields:{on:tableau.dataTypeEnum.int,off:tableau.dataTypeEnum.int}},insights_video_views_complete:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_video_views_complete_by_post_attribution:{networks:["facebook"],subfields:{organic:tableau.dataTypeEnum.int,paid:tableau.dataTypeEnum.int}},insights_video_views_complete_unique:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_video_views_complete_unique_by_post_attribution:{networks:["facebook"],subfields:{organic:tableau.dataTypeEnum.int,paid:tableau.dataTypeEnum.int}},insights_video_views_distribution:{networks:["facebook"],subfields:{owned:tableau.dataTypeEnum.int,shared:tableau.dataTypeEnum.int}},insights_video_views_unique:{networks:["facebook"],type:tableau.dataTypeEnum.int},insights_video_views_unique_by_post_attribution:{networks:["facebook"],subfields:{organic:tableau.dataTypeEnum.int,paid:tableau.dataTypeEnum.int}}},$login=$("#login"),$loginSpinner=$("#loginSpinner").hide();async function fetchProfilesAndLabels(){SBKS.profiles={};let e={};for(const s of SBKS.networks)e[s]=callSbksApi(`3/${s}/profiles`,"GET");var t,a,n=callSbksApi("3/profile/labels","GET"),i=callSbksApi("3/post/labels","GET");await Promise.all(Object.values(e));for([t,a]of Object.entries(e)){let e={success:!1};try{e=await a}catch(e){return void showModal("Profiles API error",e.toString())}if(!e.success)return showModal("API authorization failed",`API connection failed.<br><br><code>${JSON.stringify(e.errors)}</code>`),-1;if(e.profiles.length){e.profiles.sort((e,t)=>e.name.localeCompare(t.name)),SBKS.profiles[t]=e.profiles;for(const o of SBKS.profiles[t])SBKS.profile_name_by_id[o.id]=o.name;SBKS.profiles_with_no_labels[t]=SBKS.profiles[t].filter(e=>!e.profile_labels.length).map(e=>e.id)}}try{let e=await n;if(e.success){e.data.sort((e,t)=>e.name.localeCompare(t.name));for(const r of e.data)r.selected_profiles=[];SBKS.profile_labels=e.data}let t=await i;t.success&&(t.data.sort((e,t)=>e.name.localeCompare(t.name)),SBKS.post_labels=t.data)}catch(e){showModal("Labels API error",e.toString())}$.isEmptyObject(SBKS.profiles)&&showModal("Profiles not available","Your account doesn't have any profiles connected.")}async function onLoginSubmit(e){e.preventDefault(),$loginSpinner.show(),tableau.username=$("#token").val(),tableau.password=$("#secret").val(),-1!=await fetchProfilesAndLabels()?($login.hide(),renderProfiles()):$loginSpinner.hide()}function showModal(e,t){$("#modalTitle").text(e),$("#modalBody").html(t);let a=new bootstrap.Modal(document.getElementById("modal"));$("#modalButton").click(e=>{a.hide()}),a.show()}$(function(){$login.submit(onLoginSubmit),$("#profiles .back").click(function(){$("[id$=Spinner]").hide(),$("#profiles").hide(),$("#login").show()}),$("#profileMetrics .back,#aggregatedPostMetrics .back, #posts .back").click(function(){$("[id$=Spinner]").hide(),$("#profileMetrics, #aggregatedPostMetrics, #posts").hide(),$("#profiles").show()})});let $postsDiv=$("#posts"),$posts=$("#postsForm"),$postsSorts=$("#postsSorts"),$postsSpinner=$("#postsSpinner").hide(),$advancedFilteringSwitch=$("#advancedFiltering"),$basicFiltering=$("#basicFiltering");function processFormField(e,t){var a;return e=e||{},-1!==t.name.indexOf("[]")?(e[a=t.name.replace("[]","")]=e[a]||[],e[a].push(t.value)):e[t.name]=t.value,e}$(function(){$posts.submit(onPostsSubmit)});async function onPostsSubmit(e){e.preventDefault(),$postsSpinner.show();let t={},a={};for(const n of $posts.serializeArray())if(!["",void 0,null].includes(n.value))if("daterange"!==n.name){let e=!1;for(const i of SBKS.networks){if(0===n.name.indexOf(i)){n.name=n.name.replace(`${i}-`,""),a[i]=processFormField(a[i],n),e=!0;break}if(!e&&0<n.name.indexOf(i)){n.name=n.name.replace(`_${i}`,""),t[i]=processFormField(t[i],n),e=!0;break}}e||(t=processFormField(t,n))}else SBKS.date_range=parseDateRange(n.value);SBKS.posts_filters=t,SBKS.posts_networks=a,tableau.connectionData=JSON.stringify(SBKS),invokeConnector(SBKS.data_source)}function renderPosts(){$postsSorts.empty(),renderPostsSorts(),$postsDiv.show(),$("select").each(function(){10<$(this).outerWidth()&&$(this).css({width:`${$(this).outerWidth()-1}px`})}),$("select[data-sort]").each(function(){let e=$(this),a=e.data("sort");var t=Object.keys(POSTS_SORT_FIELDS).map((t,e)=>{if(POSTS_SORT_FIELDS[t].includes(a)){let e=t.replace(/_/g," ").replace(".",": ");return{id:t,text:e.charAt(0).toUpperCase()+e.slice(1),selected:"created_time"===t}}});e.select2({multiple:!0,minimumResultsForSearch:-1,data:t}).on("select2:select",function(e){let t=$(e.params.data.element);t.detach(),$(this).append(t),$(this).trigger("change")})}),$("#post_labels").select2({multiple:!0,data:SBKS.post_labels.map(e=>({id:e.id,text:e.name}))}),$("select[data-fields]").each(function(){let e=$(this);var t,a,n=e.data("fields"),i=Object.entries(SBKS.profiles_selected[n]).find(e=>e[1]?e:null);let s=[];for([t,a]of Object.entries(POSTS_FIELDS))if((!i||0!==t.indexOf("insights"))&&a.networks.includes(n)){let e=t.replace(/_/g," ");s.push({id:t,text:e.charAt(0).toUpperCase()+e.slice(1)})}e.select2({multiple:!0,data:s}).val(["page","profile","channel"]).change()}),$("select.form-select[multiple]").select2()}function renderPostsSorts(){filters=e=>`<div class="input-group mb-3" id="content_type_${e}_container">
        <label for="content_type" class="input-group-text">Content Type</label>
        <select class="form-select" name="content_type_${e}[]" id="content_type_${e}" multiple>
        </select>
        </div>
        <div class="input-group mb-3" id="grade_${e}_container">
            <label for="grade" class="input-group-text">Grade</label>
            <select class="form-select" name="grade_${e}[]" id="grade_${e}" multiple>
            </select>
        </div>
        <div class="input-group mb-3" id="media_type_${e}_container">
            <label for="media_type" class="input-group-text">Media Type</label>
            <select class="form-select" name="media_type_${e}[]" id="media_type_${e}" multiple>
            </select>
        </div>
        <div class="input-group mb-3" id="origin_${e}_container">
            <label for="origin" class="input-group-text">Origin</label>
            <select class="form-select" name="origin_${e}" id="origin_${e}">
                <option value=""></option>
            </select>
        </div>
        <div class="input-group mb-3" id="post_attribution_${e}_container">
            <label for="post_attribution" class="input-group-text">Post Attribution</label>
            <select class="form-select" name="post_attribution_${e}" id="post_attribution_${e}">
                <option value=""></option>
            </select>
        </div>
        <div class="input-group mb-3" id="video_type_${e}_container">
            <label for="video_type" class="input-group-text">Video Type</label>
            <select class="form-select" name="video_type_${e}[]" id="video_type_${e}" multiple>
            </select>
        </div>`;for(const a of Object.keys(SBKS.profiles_selected)){$postsSorts.append($(`
            <div class="capitalize" style="padding: 8px 0 12px 0; margin-left: -5px">
                <ion-icon style="vertical-align: sub; font-size: 22px;" 
                    title="${a}" name="${SBKS.icons[a]}"></ion-icon> 
                ${a}
            </div>
            ${filters(a)}
            <div class="input-group mb-3">
                <label class="input-group-text">Fields</label>
                <select class="form-select" data-fields="${a}" name="${a}-fields[]"></select>          
            </div>
            <div class="input-group mb-3" style="${"twitter"===a?"display:none":""}">
                <label class="input-group-text">Sort</label>
                <select class="form-select" data-sort="${a}" name="${a}-sort[]" multiple></select>
            </div>
            <div class="row">
                <div class="col">
                    <div class="input-group mb-3" style="${"twitter"===a?"display:none":""}">
                        <label class="input-group-text">Order</label>
                        <select class="form-select" name="${a}-order">
                            <option value="asc">Ascending</option>
                            <option value="desc" selected>Descending</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="input-group mb-3">
                        <label class="input-group-text">Limit</label>
                        <input type="number" min="1" max="100" value="100" class="form-control" name="${a}-limit">
                    </div>
                </div>
            </div>
        `));for(const[n,t]of Object.entries(POSTS_FILTER_FIELDS)){$.each(t[a],(e,t)=>{$(`#${n}_${a}`).append($("<option>",{value:t,text:t.charAt(0).toUpperCase()+t.slice(1)}))});var e=document.getElementById(`${n}_${a}`);e&&((0===(e=e.options).length||1===e.length&&""===e[0].value)&&$(`#${n}_${a}_container`).hide())}}}let $profileMetrics=$("#profileMetrics"),$profileMetricsContent=$("#profileMetricsContent"),$profileMetricsSpinner=$("#profileMetricsSpinner").hide();$(function(){$profileMetrics.submit(onProfileMetricsSubmit)});async function onProfileMetricsSubmit(e){e.preventDefault(),$profileMetricsSpinner.show(),SBKS.profile_metrics={},SBKS.profile_dimensions={};let t=null;for(const i of $profileMetrics.serializeArray()){var a,n;"daterange"!==i.name?"time"!==i.name?([a,n]=i.name.split("-"),SBKS.profile_dimensions[a]=SBKS.profile_dimensions[a]||[],SBKS.profile_metrics[a]=SBKS.profile_metrics[a]||[],t&&!SBKS.profile_dimensions[a].includes(t)&&SBKS.profile_dimensions[a].unshift(t),SBKS[n][a].push(i.value)):i.value&&(t=i.value):SBKS.date_range=parseDateRange(i.value)}tableau.connectionData=JSON.stringify(SBKS),invokeConnector(SBKS.data_source)}function renderProfileMetrics(){$profileMetricsContent.html("");let e=[];for(const t of Object.keys(SBKS.profiles_selected))e=[...e,...Object.keys(SBKS.profiles_selected[t]).filter(e=>SBKS.profiles_with_no_labels[t].includes(e))],$profileMetricsContent.append($(`
            <div class="capitalize" style="padding: 8px 0 12px 0; margin-left: -5px">
                <ion-icon style="vertical-align: sub; font-size: 22px;" 
                    title="${t}" name="${SBKS.icons[t]}"></ion-icon> 
                ${t}
            </div>
            
            <div class="input-group mb-3">
                <label class="input-group-text">Metrics</label>
                <select class="form-select" data-network="${t}" data-type="profile_metrics" 
                        name="${t}-profile_metrics"></select>
            </div>
            <div class="input-group mb-3">
                <label class="input-group-text">Dimensions</label>
                <select class="form-select" data-network="${t}" data-type="profile_dimensions" 
                        name="${t}-profile_dimensions"></select>
            </div>
        `));e.length&&$profileMetricsContent.append($(`
        <div class="alert alert-info" role="alert">
            Some profiles you selected don't have profile labels. If you select profile_label as a dimension
            the data for that profile will not be shown.<br>
            Profiles: ${e.map(e=>SBKS.profile_name_by_id[e]).join(", ")}
        </div>
        `)),$profileMetrics.show(),initProfileMetricsAndDimensions()}function initProfileMetricsAndDimensions(){$("select").each(function(){10<$(this).outerWidth()&&$(this).css({width:`${$(this).outerWidth()-1}px`})}),$("select[data-type=profile_metrics]").each(function(){let e=$(this);var t=e.data("network");let a=Object.entries(SBKS.profiles_selected[t]).find(e=>e[1]?e:null);e.empty().select2({multiple:!0,data:Object.keys(PROFILE_METRICS[t]).map(e=>{if(a||0!==e.indexOf("insights"))return{id:e,text:e}})})}).change(function(){let e=$(this),t=[];var a=e.data("network");for(const s of e.val())t=t.length?intersect(t,PROFILE_METRICS[a][s]):PROFILE_METRICS[a][s];let n=$(`select[data-type=profile_dimensions][data-network=${a}]`);var i=n.val();n.empty().select2({multiple:!0,data:t.map(e=>({id:e,text:e}))}).val(i&&i.length?i:["profile"]).trigger("change")}).trigger("change"),$(document).on("select2:select","select[data-type=dimensions]",function(a){a=a.params.data.id;if(!PROFILE_COMMON_DIMENSIONS.includes(a)){let e=$(this),t=e.val().filter(e=>PROFILE_COMMON_DIMENSIONS.includes(e));t.push(a),e.val(t).trigger("change")}})}let $profiles=$("#profiles"),$profilesSpinner=$("#profilesSpinner").hide(),$profilesTable=$("#profilesTable");async function onProfilesSubmit(e){e.preventDefault(),$profilesSpinner.show();e=$profiles.serializeArray();for(const s of e){var t=s.name.split("_"),a=t[0];"profile"===t[1]&&(SBKS.profiles_selected[a]=SBKS.profiles_selected[a]||{},SBKS.profiles_selected[a][s.value]=!1)}for(const o of e){var n=o.name.split("_"),i=n[0];"insights"===n[1]&&(SBKS.profiles_selected[i]=SBKS.profiles_selected[i]||{},SBKS.profiles_selected[i][o.value]=!0)}for(const r of SBKS.profile_labels)for(const l of r.profiles)l.platform in SBKS.profiles_selected&&l.id in SBKS.profiles_selected[l.platform]&&r.selected_profiles.push(l);$profiles.hide(),"profile"===SBKS.data_source?renderProfileMetrics():"aggregated_post"===SBKS.data_source?renderAggregatedPostMetrics():"posts"===SBKS.data_source&&renderPosts()}function filterProfiles(t){for(var[a,n]of Object.entries(SBKS.profiles)){if(!n||!n.length)return;let e=!1;for(const s of n){var i=!t||s.name.match(new RegExp("("+t+")","gi"));e=e||i,$(`tr[data-profile-id='${s.id}']`).css("display",i?"":"none").attr("data-hidden",i?"0":"1")}$(`thead[data-network=${a}]`).css("display",e?"":"none").attr("data-hidden",e?"0":"1")}}function renderProfiles(){$profilesTable.html("");for(var[e,t]of Object.entries(SBKS.profiles))if(t&&t.length&&("profile"!==SBKS.data_source||"vkontakte"!==e)){$profilesTable.append($(`
            <thead data-network="${e}">
                <tr>
                    <th style="width: 30px" title="Select all">
                        <input class="form-check-input" type="checkbox" data-select-multiple="${e}_profile" />
                    </th>
                    <th>
                        <ion-icon style="vertical-align: sub;font-size: 22px;"
                            title="${e}" name="${SBKS.icons[e]}"></ion-icon> ${e}</th>
                    <th>ID</th>
                    <th>Insights</th>
                    <th class="toggleTbody" title="Toggle"><ion-icon name="caret-up-outline"></ion-icon></th>
                </tr>
            </thead>`));var a=$(`<tbody data-network="${e}">`);for(const n of t)renderProfile(e,n,a);$profilesTable.append(a)}$profiles.show()}function renderProfile(e,t,a){a.append($(`<tr data-profile-id="${t.id}" data-hidden="0">
               <td><input class="form-check-input" type="checkbox" name="${e}_profile" value="${t.id}"></td>
               <td><img src="${t.picture}" alt="${t.name}"/> ${t.name}</td>
               <td>${t.id}</td>
               <td colspan="2">
                   <input class="form-check-input" style="display: ${t.insights_enabled?"block":"none"}" 
                          type="checkbox" name="${e}_insights" value="${t.id}">
               </td>
           </tr>`))}$(function(){$profiles.submit(onProfilesSubmit),$("[data-source-type]").click(function(e){e.preventDefault(),SBKS.data_source=$(this).data("source-type"),$("#data_source").text($(this).text()),renderProfiles(),$("#search").keyup()}),$(document).on("change","[data-select-multiple]",function(){let e=$(this);$(`tr[data-hidden=0] input[name=${e.data("select-multiple")}]`).each(function(){$(this).prop("checked",e.prop("checked")).change()})}),$(document).on("change","input[type=checkbox][name$=_profile]",function(){$("#profiles button[type=submit]").prop("disabled",!$("input[type=checkbox][name$=_profile]:checked").length)}),$(document).on("click","#profiles tbody tr",function(e){if("checkbox"!==e.target.type){let e=$(this).find(":checkbox").first();e.prop("checked",!e.prop("checked")).change()}}),$(document).on("keyup","#search",function(){if(filterProfiles($(this).val()),!$("tr[data-hidden=0]").length){let e=$(this),t=e.val();e.val(t.substring(0,t.length-1)).keyup()}}),$(document).on("click","th.toggleTbody",function(){let e=$(this);var t=e.parents("thead").data("network");let a=$(`tbody[data-network=${t}]`),n=e.find("ion-icon");"caret-up-outline"===n.attr("name")?(a.css("display","none"),n.attr("name","caret-down-outline")):(a.css("display",""),n.attr("name","caret-up-outline"))}),$("#clearSearch").click(function(){$("#search").val("").keyup()})});const MAX_PROFILES=100,MAX_METRICS=25,MAX_DAYS=360,MAX_POSTS_ARRAY_DEPTH=10;let tableauConnector=tableau.makeConnector();function invokeConnector(e){"profile"===e?tableau.connectionName="Socialbakers social media profiles":"aggregated_post"===e?tableau.connectionName="Socialbakers social media aggregated post metrics":"posts"===e&&(tableau.connectionName="Socialbakers social media posts"),tableau.submit()}tableauConnector.init=e=>{tableau.authType=tableau.authTypeEnum.custom,e()},tableauConnector.getSchema=e=>{var t=JSON.parse(tableau.connectionData);let a=[];if("profile"===t.data_source){a.push({id:"platform",dataType:tableau.dataTypeEnum.string});for(var[n,i]of Object.entries(t.profile_metrics)){for(const c of i||[])a=appendMetricColumn(c,a);for(const p of t.profile_dimensions[n]||[])a=appendDimensionColumn(p,a,t)}}else if("aggregated_post"===t.data_source){for(const d of t.aggregated_post_metrics||[])a=appendMetricColumn(d,a);for(const u of t.aggregated_post_dimensions||[])a=appendDimensionColumn(u,a,t)}else if("posts"===t.data_source)for(const m of Object.values(t.posts_networks))for(const g of m.fields||[]){var s=POSTS_FIELDS[g];if(s.type)a=appendColumn(a,g,s.type);else if(s.array&&s.subfields)for(let e=1;e<MAX_POSTS_ARRAY_DEPTH;e++)for(var[o,r]of Object.entries(s.subfields))a=appendColumn(a,`${g}_${o}_${e}`,r);else if(s.subfields)for(var[l,_]of Object.entries(s.subfields))a=appendColumn(a,`${g}_${l}`,_)}a.length&&e([{id:t.data_source,alias:t.data_source,columns:a}])},tableauConnector.getData=async(e,t)=>{var a=JSON.parse(tableau.connectionData);"profile"===a.data_source?e.appendRows(await getProfileData(a)):"aggregated_post"===a.data_source?e.appendRows(await getAggregatedPostData(a)):"posts"===a.data_source&&e.appendRows(await getPostsData(a)),t()},tableau.registerConnector(tableauConnector);